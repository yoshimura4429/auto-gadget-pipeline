name: Generate Article

on:
  workflow_dispatch:
    inputs:
      category:
        description: "ã‚«ãƒ†ã‚´ãƒªï¼ˆæ´»ç”¨æ³• / é€Ÿå ± / ç†±é‡ï¼‰"
        required: true
        default: "æ´»ç”¨æ³•"
      keyword:
        description: "å©ãå°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹: iPad ä¸è¦ï¼‰â€»å…¥ã‚Œã‚‹ã¨Redditã‹ã‚‰å©ãå°è‡ªå‹•ç”Ÿæˆ"
        required: false
        default: ""
      material:
        description: "ç´ æãƒ†ã‚­ã‚¹ãƒˆï¼ˆkeywordæœªå…¥åŠ›ã®ã¨ãã«ä½¿ç”¨ï¼‰"
        required: false
        default: ""
      angle:
        description: "è¨˜äº‹ã®æ–¹å‘æ€§ï¼ˆä¾‹: ãã‚Œã§ã‚‚iPadãŒæ¬²ã—ã„ï¼‰"
        required: false
        default: ""

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          pip install -r requirements.txt          
      - name: Stage1 - make draft from Reddit (when keyword is given)
        if: ${{ inputs.keyword != '' }}
        env:
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USER_AGENT: ${{ secrets.REDDIT_USER_AGENT }}
        run: |
          mkdir -p inputs
          echo "ðŸ”Ž build draft via Reddit with keyword='${{ inputs.keyword }}'"
          python3 stage1_reddit.py --keyword "${{ inputs.keyword }}"
          test -f inputs/draft.md || (echo "draft.md not generated" && exit 1)

      # B) keyword ãŒç©ºãªã‚‰ã€ãƒ•ã‚©ãƒ¼ãƒ ã®ç´ æãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«åŒ–
        - name: Write material to file (when keyword empty)
        if: ${{ github.event.inputs.keyword == '' }}
        shell: bash
        run: |
          mkdir -p inputs
          printf "%s" "${{ github.event.inputs.material }}" > inputs/draft.md

      # ---- ç¬¬2æ®µéšŽï¼šæœ¬è¨˜äº‹ç”Ÿæˆ ----
      - name: Run pipeline
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_PROJECT: ${{ secrets.OPENAI_PROJECT }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
        run: |
          set -e
          CATEGORY="${{ github.event.inputs.category }}"
          ANGLE_INPUT="${{ github.event.inputs.angle }}"
          EXTRA=""
          if [ -n "$ANGLE_INPUT" ]; then
            EXTRA="--angle \"$ANGLE_INPUT\""
          fi
          echo "â–¶ï¸ python3 pipeline.py --category \"$CATEGORY\" --source_file inputs/draft.md $EXTRA"
          eval python3 pipeline.py --category "$CATEGORY" --source_file inputs/draft.md $EXTRA

      - name: Upload article artifact
        uses: actions/upload-artifact@v4
        with:
          name: article-md
          path: dist/*.md

      - name: Job Summary
        run: |
          echo "### âœ… ç”Ÿæˆå®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "- ã‚«ãƒ†ã‚´ãƒª: ${{ github.event.inputs.category }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ github.event.inputs.keyword }}" ]; then
            echo "- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${{ github.event.inputs.keyword }}" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${{ github.event.inputs.angle }}" ]; then
            echo "- è§’åº¦: ${{ github.event.inputs.angle }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- å‡ºåŠ›: dist/ é…ä¸‹ã€‚ä¸Šéƒ¨ **Artifacts** ã‹ã‚‰DLå¯èƒ½" >> $GITHUB_STEP_SUMMARY
