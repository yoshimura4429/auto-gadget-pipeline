name: Generate Article

on:
  workflow_dispatch:
    inputs:
      category:
        description: "カテゴリ（活用法 / 速報 / 熱量）"
        required: true
        default: "活用法"
      keyword:
        description: "叩き台キーワード（例: iPad 不要）※入れるとRedditから叩き台自動生成"
        required: false
        default: ""
      material:
        description: "素材テキスト（keyword未入力のときに使用）"
        required: false
        default: ""
      angle:
        description: "記事の方向性（例: それでもiPadが欲しい）"
        required: false
        default: ""

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          pip install -r requirements.txt          
      - name: Stage1 - make draft from Reddit (when keyword is given)
        if: ${{ inputs.keyword != '' }}
        env:
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USER_AGENT: ${{ secrets.REDDIT_USER_AGENT }}
        run: |
          mkdir -p inputs
          echo "🔎 build draft via Reddit with keyword='${{ inputs.keyword }}'"
          python3 stage1_reddit.py --keyword "${{ inputs.keyword }}"
          test -f inputs/draft.md || (echo "draft.md not generated" && exit 1)

      # B) keyword が空なら、フォームの素材テキストをファイル化
        - name: Write material to file (when keyword empty)
        if: ${{ github.event.inputs.keyword == '' }}
        shell: bash
        run: |
          mkdir -p inputs
          printf "%s" "${{ github.event.inputs.material }}" > inputs/draft.md

      # ---- 第2段階：本記事生成 ----
      - name: Run pipeline
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_PROJECT: ${{ secrets.OPENAI_PROJECT }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
        run: |
          set -e
          CATEGORY="${{ github.event.inputs.category }}"
          ANGLE_INPUT="${{ github.event.inputs.angle }}"
          EXTRA=""
          if [ -n "$ANGLE_INPUT" ]; then
            EXTRA="--angle \"$ANGLE_INPUT\""
          fi
          echo "▶️ python3 pipeline.py --category \"$CATEGORY\" --source_file inputs/draft.md $EXTRA"
          eval python3 pipeline.py --category "$CATEGORY" --source_file inputs/draft.md $EXTRA

      - name: Upload article artifact
        uses: actions/upload-artifact@v4
        with:
          name: article-md
          path: dist/*.md

      - name: Job Summary
        run: |
          echo "### ✅ 生成完了" >> $GITHUB_STEP_SUMMARY
          echo "- カテゴリ: ${{ github.event.inputs.category }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ github.event.inputs.keyword }}" ]; then
            echo "- キーワード: ${{ github.event.inputs.keyword }}" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${{ github.event.inputs.angle }}" ]; then
            echo "- 角度: ${{ github.event.inputs.angle }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- 出力: dist/ 配下。上部 **Artifacts** からDL可能" >> $GITHUB_STEP_SUMMARY
