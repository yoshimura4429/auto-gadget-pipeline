import os
import json
import argparse
from pathlib import Path
import requests
from datetime import datetime
from dotenv import load_dotenv
load_dotenv()

# ====== .env èª­ã¿è¾¼ã¿ ======
from dotenv import load_dotenv
import os

load_dotenv(dotenv_path=".env")  # â† æ˜ç¤ºçš„ã« .env ã‚’æŒ‡å®š
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
OPENAI_PROJECT = os.getenv("OPENAI_PROJECT")
OPENAI_ORG = os.getenv("OPENAI_ORG")  # ã‚ã‚Œã°
MODEL = os.getenv("OPENAI_MODEL", "gpt-4.1-mini")

# ====== ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ======
PROMPTS = {
    "æ´»ç”¨æ³•": """ã‚ãªãŸã¯ã€Œã‚¬ã‚¸ã‚§ãƒƒãƒˆã¯ã‚€ãŠã£ã¡ã€ã¨ã„ã†ç†±é‡ã‚ã‚‹ãƒ–ãƒ­ã‚¬ãƒ¼ã§ã™ã€‚
ãƒ†ãƒ¼ãƒã¯ã€Œäººæ°—ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®æ´»ç”¨æ³•ã€ã€‚ä»¥ä¸‹ã®æ¡ä»¶ã‚’å®ˆã£ã¦è¨˜äº‹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ã€ã‚¹ã‚¿ã‚¤ãƒ«æ¡ä»¶ã€‘
- ä¸€äººç§°ï¼ˆã€Œãƒ¯ã‚¿ã‚·ã¯ã€œã€ï¼‰ã§èªã‚Šã‹ã‘ã‚‹ã€‚
- èª­è€…ãŒã€Œè‡ªåˆ†ã‚‚ã‚„ã£ã¦ã¿ãŸã„ã€ã¨æ€ã†ã‚ˆã†ã«ã€å…·ä½“çš„ãªæ´»ç”¨ã‚·ãƒ¼ãƒ³ã‚’æå†™ã™ã‚‹ã€‚
- å¾“æ¥ã®æ–¹æ³•ã‚„ä»–ãƒ‡ãƒã‚¤ã‚¹ã¨ã®æ¯”è¼ƒã‚’æŒŸã¿ã€èª¬å¾—åŠ›ã‚’å¢—ã™ã€‚
- ã€Œã‚ã‹ã‚‹ã‚ˆã€ãã®æ°—æŒã¡ã€ãªã©å…±æ„Ÿã®ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å¿…ãšå…¥ã‚Œã‚‹ã€‚
- å…±æ„Ÿ â†’ ä¸»å¼µ â†’ è‚¯å®š ã®æµã‚Œã‚’æ„è­˜ã™ã‚‹ã€‚
- æœ€å¾Œã¯ã€Œã“ã®æ–¹æ³•ã‚’è©¦ã›ã€ã€Œè¿·ã£ã¦ã‚‹æ™‚é–“ãŒç„¡é§„ã€ã¨æ–­è¨€ã§èƒŒä¸­ã‚’æŠ¼ã™ã€‚
- é©åº¦ã«æ”¹è¡Œã—ã¦ãƒªã‚ºãƒ ã‚ˆãã€å£èªè¡¨ç¾ã‚’äº¤ãˆã‚‹ã€‚

ã€è¨˜äº‹æ§‹æˆã€‘
1. å°å…¥ï¼ˆè‡ªåˆ†ã®ä½“é¨“ã‚’äº¤ãˆã¦ã€æ‚©ã¿ã‚„ãã£ã‹ã‘ã‚’æ›¸ãï¼‰
2. æ´»ç”¨ã‚·ãƒ¼ãƒ³æå†™ï¼ˆã©ã†ä¾¿åˆ©ã‹ï¼ãƒ¡ãƒªãƒƒãƒˆã‚’æ„Ÿæƒ…ãƒ™ãƒ¼ã‚¹ã§ï¼‰
3. æ¯”è¼ƒã¨èª¬å¾—ï¼ˆä»–ã®ã‚„ã‚Šæ–¹ãƒ»ã‚¬ã‚¸ã‚§ãƒƒãƒˆã¨ã®é•ã„â†’ã ã‹ã‚‰å¼·ã„ï¼‰
4. è½ã¨ã—ç©´ãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆï¼ˆæ­£ç›´ã«æç¤ºâ†’è§£æ±ºç­–ã‚„å‰å‘ãè»¢æ›ï¼‰
5. çµè«–ã¨èƒŒä¸­æŠ¼ã—ï¼ˆã‚µãƒ–é‹ç”¨ãƒ»ã‚¯ãƒ©ã‚¦ãƒ‰ä½µç”¨ãªã©ã‚’æç¤ºã—ã¦ã€Œè©¦ã›ã€ã§ç· ã‚ï¼‰

ã€æ–‡å­—æ•°ã€‘
- å…¨ä½“ã§ 2000ã€œ2500å­—ç¨‹åº¦

ã€ç´ æï¼ˆå©ãå°ï¼‰ã€‘
ä»¥ä¸‹ã®ç´ æã‚’ä¸‹æ•·ãã«ã€ä¸Šè¨˜æ¡ä»¶ã§è‡ªç­†è¨˜äº‹ã®ã‚ˆã†ã«ãƒªãƒ©ã‚¤ãƒˆã—ã¦ãã ã•ã„ã€‚
""",

    "é€Ÿå ±": """ã‚ãªãŸã¯ã€Œã‚¬ã‚¸ã‚§ãƒƒãƒˆã¯ã‚€ãŠã£ã¡ã€ã¨ã„ã†ç†±é‡ã‚ã‚‹ãƒ–ãƒ­ã‚¬ãƒ¼ã§ã™ã€‚
ãƒ†ãƒ¼ãƒã¯ã€Œæ–°å•†å“ã‚„æ–°æƒ…å ±ã«è§¦ã‚ŒãŸã¨ãã®é€Ÿå ±è¨˜äº‹ã€ã€‚ä»¥ä¸‹ã®æ¡ä»¶ã‚’å®ˆã£ã¦è¨˜äº‹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ã€ã‚¹ã‚¿ã‚¤ãƒ«æ¡ä»¶ã€‘
- ä¸€äººç§°ï¼ˆã€Œãƒ¯ã‚¿ã‚·ã¯ã€œã€ï¼‰ã§èªã‚Šã‹ã‘ã‚‹ã€‚
- æ„Ÿæƒ…ã®é«˜ã¾ã‚Šã‚’æœ€å„ªå…ˆï¼ˆé©šããƒ»è¡æ’ƒãƒ»æœŸå¾…ã‚’å‰é¢ã«ï¼‰ã€‚
- çŸ­ã‚ã‚»ãƒ³ãƒ†ãƒ³ã‚¹å¤šç”¨ã§ã‚¹ãƒ”ãƒ¼ãƒ‰æ„Ÿã€‚
- å €æ±Ÿè²´æ–‡çš„ã ãŒãƒã‚¤ãƒ«ãƒ‰ãªæ–­è¨€ï¼ˆã€Œã“ã‚Œã¯è²·ã†ã—ã‹ãªã„ã€ã€Œæ­£è§£ã¯ã“ã£ã¡ã€ï¼‰ã€‚
- ã€Œä»Šã€ã€Œã¤ã„ã«ã€ã€Œã‚„ã£ã¨ã€ã€Œéœ‡ãˆãŸã€ãªã©ã®æ™‚é–“ï¼æ„Ÿæƒ…ãƒ¯ãƒ¼ãƒ‰ã‚’ç››ã‚Šè¾¼ã‚€ã€‚
- æœ€å¾Œã¯ã€Œã“ã‚Œã¯ã‚‚ã†è¡Œã‘ã€ã€Œæ‚©ã‚€æš‡ã¯ãªã„ã€ã§å³æ–­å³æ±ºã®ç· ã‚ã€‚

ã€è¨˜äº‹æ§‹æˆã€‘
1. å°å…¥ï¼šé€Ÿå ±æ„Ÿã‚’ç…½ã‚‹ï¼ˆç™ºè¡¨ãƒ»è³¼å…¥ãƒ»åˆä½“é¨“ã‚’ç›´çƒã§ï¼‰
2. ç¬¬ä¸€å°è±¡ã¨è¡æ’ƒãƒã‚¤ãƒ³ãƒˆï¼ˆã‚¹ãƒšãƒƒã‚¯ï¼è¦‹ãŸç›®ï¼è§¦æ„Ÿã€å…·ä½“æ¯”è¼ƒã‚‚å°‘ã—ï¼‰
3. æœŸå¾…ã¨æºã‚‰ãï¼ˆä¸å®‰â†’è§¦ã£ã¦å¹ãé£›ã¶ç­‰ã®æ„Ÿæƒ…ã®èµ·ä¼ï¼‰
4. ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã‚„æ‡¸å¿µï¼ˆæ­£ç›´ã•â†’ãã‚Œã§ã‚‚æ¬²ã—ã„ã§ä¸Šæ›¸ãï¼‰
5. çµè«–ï¼šå³æ±ºã‚’è¿«ã‚‹ä¸€è¨€ï¼ˆä»Šã™ãè§¦ã‚Œï¼è²·ãˆï¼‰

ã€æ–‡å­—æ•°ã€‘
- å…¨ä½“ã§ 1500ã€œ2000å­—ç¨‹åº¦

ã€ç´ æï¼ˆå©ãå°ï¼‰ã€‘
ä»¥ä¸‹ã®ç´ æã‚’ä¸‹æ•·ãã«ã€ä¸Šè¨˜æ¡ä»¶ã§è‡ªç­†è¨˜äº‹ã®ã‚ˆã†ã«ãƒªãƒ©ã‚¤ãƒˆã—ã¦ãã ã•ã„ã€‚
""",

    "ç†±é‡": """ã‚ãªãŸã¯ã€Œã‚¬ã‚¸ã‚§ãƒƒãƒˆã¯ã‚€ãŠã£ã¡ã€ã¨ã„ã†ç†±é‡ã‚ã‚‹ãƒ–ãƒ­ã‚¬ãƒ¼ã§ã™ã€‚
ãƒ†ãƒ¼ãƒã¯ã€Œå¥½ããªã‚¬ã‚¸ã‚§ãƒƒãƒˆã¸ã®ç†±ã„æƒ³ã„ã€ã€‚ä»¥ä¸‹ã®æ¡ä»¶ã‚’å®ˆã£ã¦è¨˜äº‹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ã€ã‚¹ã‚¿ã‚¤ãƒ«æ¡ä»¶ã€‘
- ä¸€äººç§°ï¼ˆã€Œãƒ¯ã‚¿ã‚·ã¯ã€œã€ï¼‰ã§èªã‚Šã‹ã‘ã‚‹ã€‚
- ç†±é‡ã¨æ„Ÿæƒ…ã‚’å‰é¢ã«ï¼ˆã€Œæœ€é«˜ã™ããŸã€ã€Œå¿ƒãŒéœ‡ãˆãŸã€ã€Œã“ã‚Œã¯ãƒ¤ãƒã„ã€ï¼‰ã€‚
- å €æ±Ÿè²´æ–‡çš„ã ãŒãƒã‚¤ãƒ«ãƒ‰ãªæ–­è¨€ï¼ˆã€Œã“ã‚Œã§ã„ã„ã€ã€Œæ­£è§£ã¯ã“ã£ã¡ã ã€ã€Œæ‚©ã‚€æ™‚é–“ãŒç„¡é§„ã€ï¼‰ã€‚
- å…±æ„Ÿ â†’ ç†±é‡çˆ†ç™º â†’ è‚¯å®š ã®ä¸‰æ®µæ§‹ãˆã€‚
- ã€Œæ‰€æœ‰æ¬²ã€ã€Œãƒ¯ã‚¯ãƒ¯ã‚¯ã€ã€Œæ‰‹ã«å…¥ã‚ŒãŸç¬é–“ã®è¡æ’ƒã€ã‚’å¿…ãšç››ã‚Šè¾¼ã‚€ã€‚
- æ”¹è¡Œã§ãƒ†ãƒ³ãƒã‚’ä½œã‚Šã€èª­è€…ã‚’ä¸€æ°—ã«å¼•ãè¾¼ã‚€ã€‚

ã€è¨˜äº‹æ§‹æˆã€‘
1. å°å…¥ï¼šç†±é‡ã®ç¨®ç«ï¼ˆå‡ºä¼šã„ï¼æƒ¹ã‹ã‚ŒãŸç¬é–“ï¼å…±æ„Ÿãƒ•ãƒƒã‚¯ï¼‰
2. ç†±ä¸­ãƒã‚¤ãƒ³ãƒˆæå†™ï¼ˆæƒšã‚Œè¾¼ã‚“ã ç†ç”±ã‚’æ„Ÿæƒ…ã‚€ãå‡ºã—ã§ï¼‰
3. æ¯”è¼ƒã¨æºã‚‰ãï¼ˆä»–ã‚¬ã‚¸ã‚§ãƒƒãƒˆãƒ»éå»ã®è‡ªåˆ†ã¨ã®æ¯”è¼ƒâ†’ã‚„ã£ã±ã‚Šã“ã‚Œï¼‰
4. ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã‚„è‘›è—¤ï¼ˆæ­£ç›´ã«èªã‚ã¤ã¤ã€Œãã‚Œã§ã‚‚å¥½ãã€ã§ä¸Šæ›¸ãï¼‰
5. çµè«–ã¨èƒŒä¸­æŠ¼ã—ï¼ˆæ‰€æœ‰ã—ã¦ã“ãæ„å‘³ï¼ä»Šã™ãè§¦ã‚Œï¼‰

ã€æ–‡å­—æ•°ã€‘
- å…¨ä½“ã§ 2200ã€œ2700å­—ç¨‹åº¦

ã€ç´ æï¼ˆå©ãå°ï¼‰ã€‘
ä»¥ä¸‹ã®ç´ æã‚’ä¸‹æ•·ãã«ã€ä¸Šè¨˜æ¡ä»¶ã§è‡ªç­†è¨˜äº‹ã®ã‚ˆã†ã«ãƒªãƒ©ã‚¤ãƒˆã—ã¦ãã ã•ã„ã€‚
"""
}

# ====== APIå‘¼ã³å‡ºã— ======
def call_openai(system_prompt, user_prompt, category):
    import os, json, requests
    from dotenv import load_dotenv
    load_dotenv()

    key = os.getenv("OPENAI_API_KEY", "")
    org = os.getenv("OPENAI_ORG", "") or os.getenv("OPENAI_ORGANIZATION", "")
    proj = os.getenv("OPENAI_PROJECT", "")
    model = os.getenv("OPENAI_MODEL", "gpt-4.1")
    temperature = 0.9 if category in ("é€Ÿå ±", "ç†±é‡") else 0.7

    headers = {"Authorization": f"Bearer {key}", "Content-Type": "application/json"}
    if org:
        headers["OpenAI-Organization"] = org
    if proj:
        headers["OpenAI-Project"] = proj

    # ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºï¼ˆã‚­ãƒ¼æœ¬ä½“ã¯å‡ºã•ãªã„ï¼‰
    print(f"ğŸ”‘ key_len={len(key) if key else 0} | org={'ON' if org else 'OFF'} | proj={'ON' if proj else 'OFF'} | model={model}")

    # ã¾ãš /models ã‚’å©ã„ã¦åˆ°é”ç¢ºèª
    try:
        r0 = requests.get("https://api.openai.com/v1/models", headers=headers, timeout=15)
        print("â„¹ï¸  /v1/models ->", r0.status_code)
        if r0.status_code != 200:
            print(r0.text[:600])
    except Exception as e:
        print("âš ï¸  /v1/models error:", e)

    payload = {
        "model": model,
        "messages": [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ],
        "temperature": temperature
    }

    url = "https://api.openai.com/v1/chat/completions"
    r = requests.post(url, headers=headers, json=payload, timeout=60)
    print("ğŸ›°  /chat/completions ->", r.status_code)
    if r.status_code != 200:
        print("BODY:", r.text[:1200])  # ã‚¨ãƒ©ãƒ¼æœ¬æ–‡ã‚’å¯è¦–åŒ–
        r.raise_for_status()

    return r.json()["choices"][0]["message"]["content"]

# ====== å¼•æ•° ======
def parse_args():
    p = argparse.ArgumentParser()
    p.add_argument("--category", required=True,
                   choices=["æ´»ç”¨æ³•", "é€Ÿå ±", "ç†±é‡"],
                   help="è¨˜äº‹ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ")
    p.add_argument("--source_file",
                   help="å©ãå°ãƒ†ã‚­ã‚¹ãƒˆï¼ˆ.md/.txtï¼‰ã€‚æŒ‡å®šæ™‚ã¯åé›†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦è¨˜äº‹åŒ–ã®ã¿å®Ÿè¡Œ")
    return p.parse_args()

# ====== ãƒ¡ã‚¤ãƒ³ ======
def main():
    args = parse_args()

    # ç´ æã®æº–å‚™
    if args.source_file:
        material = Path(args.source_file).read_text(encoding="utf-8").strip()
    else:
        raise ValueError("ç¾çŠ¶ã¯ --source_file ã‚’å¿…é ˆã¨ã—ã¦ãã ã•ã„ï¼ˆåé›†æ©Ÿèƒ½æœªæ¥ç¶šï¼‰")

    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
    system_prompt = PROMPTS[args.category]
    user_prompt = f"ã€ç´ æã€‘\n{material}\n"

    # APIå‘¼ã³å‡ºã—
    article_md = call_openai(system_prompt, user_prompt, args.category)

    # ä¿å­˜
    outdir = Path("dist")
    outdir.mkdir(exist_ok=True)
    today = datetime.now().strftime("%Y%m%d")
    outfile = outdir / f"{today}-{args.category}.md"
    outfile.write_text(article_md, encoding="utf-8")
    print(f"âœ… è¨˜äº‹ç”Ÿæˆå®Œäº†: {outfile}")

if __name__ == "__main__":
    main()
